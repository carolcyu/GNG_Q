<!DOCTYPE html>
<html>
  <head>
    <title>Welcome (GNG Scanner)</title>
    <script src="lib/jspsych/jspsych.js"></script>
    <script src="lib/jspsych/plugin-image-keyboard-response.js"></script>
    <script src="lib/jspsych/plugin-html-keyboard-response.js"></script>
    <script src="lib/jspsych/plugin-html-button-response.js"></script>
    <script src="lib/jspsych/plugin-preload.js"></script>
    <link href="lib/jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="lib/jspsych/my_experiment_style_GNG.css">
  </head> 
  <body></body>
  <script>
/* TASK INFO: GNG for scanner with button responses */
console.log('[GNG] Experiment initializing...');
console.log('[GNG] Version: Standalone (Scanner)');
console.log('[GNG] Response key: F');

/* initialize jsPsych */
var jsPsych = initJsPsych({
    on_trial_start: function() {
        var trial = jsPsych.getCurrentTrial();
        console.log('[GNG] Trial starting:', {
            trial_type: trial.type,
            task: trial.data ? trial.data.task : 'unknown',
            trial_index: jsPsych.getProgress().current_trial_global
        });
    },
    on_trial_finish: function(data) {
        console.log('[GNG] Trial finished:', {
            trial_type: data.trial_type,
            task: data.task || 'unknown',
            response: data.response,
            rt: data.rt,
            correct: data.correct,
            trial_index: jsPsych.getProgress().current_trial_global
        });
    },
    on_finish: function() {
        console.log('[GNG] Experiment completed!');
        var allData = jsPsych.data.get();
        var responseTrials = allData.filter({task: 'response'});
        console.log('[GNG] Final statistics:', {
            total_trials: responseTrials.count(),
            correct_trials: responseTrials.filter({correct: true}).count(),
            go_trials: responseTrials.filter({correct_response: 'f'}).count(),
            no_go_trials: responseTrials.filter({correct_response: null}).count()
        });
        jsPsych.data.displayData();
    }
}); 

/* create timeline */
var timeline = [];
console.log('[GNG] Timeline created');

    /* define welcome message trial */
    var welcome = {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<p>Welcome to another Task!</p><p>Press any button for instructions.</p>",
        choices: ['NEXT'],
        on_finish: function() {
            console.log('[GNG] Welcome screen completed');
        }
    };
    timeline.push(welcome);

    /* define instructions trial */
    var instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<p>In this experiment, a circle will appear in the center of the screen.</p>",
        choices: ['NEXT']
    };
    timeline.push(instructions);

    var instructions1 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>If the circle is <strong>blue</strong>, <u>press the letter F key</u> as fast as you can.</p>
            <div class='left center-content'>
                <img src='img/blue.png' alt='Blue circle'>
                <p class='small' style="color: dodgerblue;"><strong>Press the F key</strong></p>
            </div>
        `,
        choices: ['NEXT']
    };
    timeline.push(instructions1);

    var instructions2 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>If the circle is <strong>orange</strong>, <u>do not press any key</u>.</p>
            <div class='right center-content'>
                <img src='img/orange.png' alt='Orange circle'>
                <p class='small' style="color: coral;"><strong>Do not press a key</strong></p>
            </div>
            <br><br><p><i>When you are ready, press any key to begin.</i></p>
        `,
        choices: ['NEXT'],
        post_trial_gap: 1000
    };
    timeline.push(instructions2);

    /*questions for the examiner*/
    var questions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<p>If you have questions or concerns, please signal to the examiner.</p><p>If not, press any button to continue.</p>",
        choices: ['NEXT']
    };
    timeline.push(questions);

/*define trial awaiting for the scanner keyboard button #5 */
var MRIstart = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "<p>Please wait while the scanner starts up. This will take 10 seconds.</p>",
    choices: ['5'],
    prompt: "<p>A color circle will appear when the task starts.</p>",
    response_ends_trial: true,
    data: {
        task: 'mri_start'
    },
    on_start: function() {
        console.log('[GNG] Waiting for MRI scanner trigger (key 5)...');
    },
    on_finish: function(data) {
        console.log('[GNG] MRI trigger received:', {
            key: data.response,
            rt: data.rt,
            timestamp: new Date().toISOString()
        });
    }
};
timeline.push(MRIstart);

    /* define test block */
    var test_stimuli = [
        {stimulus: "img/blue.png", data: {response: 'go'}, correct_response: 'f'},
        {stimulus: "img/orange.png", data: {response: 'no-go'}, correct_response: null}
    ];
    
    var fixation = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:60px;">+</div>',
        choices: "NO_KEYS",
        trial_duration: function(){
            var duration = jsPsych.randomization.sampleWithoutReplacement([250, 500, 750, 1000, 1250, 1500, 1750, 2000], 1)[0];
            console.log('[GNG] Fixation duration:', duration + 'ms');
            return duration;
        },
        data: {
            task: 'fixation'
        },
        on_start: function() {
            console.log('[GNG] Fixation cross displayed');
        }
    };

    var test_block = {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable('stimulus'),
        choices: ['F'],
        trial_duration: 1000,
        data: {
            task: 'response',
            correct_response: jsPsych.timelineVariable('correct_response')
        },
        on_start: function() {
            var trial = jsPsych.getCurrentTrial();
            var trialType = trial.data.correct_response !== null ? 'GO' : 'NO-GO';
            console.log('[GNG] Stimulus displayed:', {
                type: trialType,
                stimulus: trial.stimulus,
                expected_response: trial.data.correct_response || 'NO RESPONSE'
            });
        },
        on_finish: function(data){
            var trialType = data.correct_response !== null ? 'GO' : 'NO-GO';
            
            // Check if it is a GO trial (correct_response is 'f')
            if (data.correct_response !== null) {
                // It is correct if the key pressed matches the correct response
                data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
                console.log('[GNG] GO trial result:', {
                    type: 'GO',
                    response: data.response,
                    expected: data.correct_response,
                    correct: data.correct,
                    rt: data.rt
                });
            } 
            // Otherwise, it is a NO-GO trial (correct_response is null)
            else {
                // It is correct ONLY if no key was pressed (response is null)
                data.correct = (data.response === null);
                console.log('[GNG] NO-GO trial result:', {
                    type: 'NO-GO',
                    response: data.response,
                    expected: 'NO RESPONSE',
                    correct: data.correct,
                    rt: data.rt || 'N/A'
                });
            }
        }
    };

/* Preload images before test procedure */
var preload = {
    type: jsPsychPreload,
    auto_preload: true,
    on_finish: function(data) {
        console.log('[GNG] Preload completed:', {
            success_count: data.success_count,
            fail_count: data.fail_count,
            errors: data.errors
        });
    }
};

/* define test procedure */
var test_procedure = {
    timeline: [fixation, test_block],
    timeline_variables: test_stimuli,
    repetitions: 20,
    randomize_order: true
};

/* Add preload before test procedure */
timeline.push(preload);
timeline.push(test_procedure);

    /* define debrief */
    var debrief_block = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            var trials = jsPsych.data.get().filter({task: 'response'});
            var correct_trials = trials.filter({correct: true});
            var go_trials = trials.filter({correct_response: 'f'});
            var no_go_trials = trials.filter({correct_response: null});
            var go_correct = go_trials.filter({correct: true});
            var no_go_correct = no_go_trials.filter({correct: true});
            
            var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
            var rt = Math.round(correct_trials.select('rt').mean());
            
            var stats = {
                total_trials: trials.count(),
                correct_trials: correct_trials.count(),
                accuracy: accuracy + '%',
                avg_rt: rt + 'ms',
                go_trials: go_trials.count(),
                go_correct: go_correct.count(),
                go_accuracy: Math.round(go_correct.count() / go_trials.count() * 100) + '%',
                no_go_trials: no_go_trials.count(),
                no_go_correct: no_go_correct.count(),
                no_go_accuracy: Math.round(no_go_correct.count() / no_go_trials.count() * 100) + '%'
            };
            
            console.log('[GNG] Debrief statistics:', stats);

            return `<p>You responded correctly on ${accuracy}% of the trials.</p>
                    <p>Your average response time was ${rt}ms.</p>
                    <p>Press any key to complete the experiment. Thank you!</p>`;
        }
    };
    timeline.push(debrief_block);

    /* start the experiment */
    console.log('[GNG] Starting experiment with', timeline.length, 'timeline items');
    console.log('[GNG] Test procedure:', {
        repetitions: 20,
        stimuli_per_repetition: 2,
        total_test_trials: 40,
        randomize: true
    });
    jsPsych.run(timeline);

  </script>
</html>
